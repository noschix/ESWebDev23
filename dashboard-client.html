<!---Copyright Alfaro Mendoza, Alberto; Bernal, Isabella; Sacranie, Kabir Ahmed; Wenzler, Leonhard Paul Hariolf; Raissi, Noah Aria -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name=‚Äùrobots‚Äù content=‚Äùnoindex‚Äù>

    <title>Client Dashboard - SecretAgent</title>
    <link rel="stylesheet" href="styles.css" type="text/css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lexend&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://kit.fontawesome.com/4bebb4b770.js" crossorigin="anonymous"></script>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo-container">
                <a href="index.html"><img src="images/logo.png" alt="SecretAgent Logo" class="logo"></a>
            </div>
            <nav class="nav-menu">
                <ul class="menu-list">
                    <li class="menu-item"><a href="#">Clients</a></li>
                    <li class="menu-item"><a href="#agents">Agents</a></li>
                    <li class="menu-item"><a href="index.html" class="login">Sign Out</a></li>
                </ul>
            </nav>
        </div>
    </header>
    <section class="my-hired" style="width: 100%; padding: 30px; text-align: center;">
        <h2 class="text-title-hired">My hired Agents</h2>
    <div class="agent-grid-hired agent-grid-subpage" id="hired-results">
        <!-- Agent cards will be dynamically populated here -->
         
    </div>
    </section>  
    <section class="text-section text-section-subpage">
        <div class="text-content text-content-subpage">
                <div class="text-details">
                    <h2 class="text-title">Search for an Agent</h2>
                    <div class="search-input-container">
                        <input type="search" class="search-input" placeholder="Search...">
                    </div>
                </div>
        </div>
    </section>
    <section class="agent-grid2 agent-grid-subpage" id="agent-results">
        <!-- Agent cards will be dynamically populated here -->
    </section>
    <section class="contact-section">
        <h1 class="section-title">Need help finding an agent?</h1>
        <p class="contact-description">We're here to help and answer any question you might have. We look forward to hearing from you ü§ù 
        </p>
        <div class="contact-info">
            <div class="contact-phone">
                <i class="fa-solid fa-phone fa-2xl"></i>
                <div><h3>Hotline</h3><p>+34 123 45 67</p></div>
            </div>
            <div class="contact-email">
                <i class="fa-solid fa-envelope fa-2xl"></i>
                <div>
                    <h3>Email</h3>
                    <p>info@SecretAgent.com</p>
                </div>
            </div>
            <div class="contact-address">
                <i class="fa-solid fa-map-marker-alt fa-2xl"></i>
                <div>
                    <h3>Office Address</h3>
                    <p>Carrer del Rossello 20, Barcelona, ES</p>
                </div>
            </div>
            <div class="contact-hours">
                <i class="fa-solid fa-clock fa-2xl"></i>
                <div>
                    <h3>Contact Hours</h3>
                    <p>9:00 - 15:00</p>
                </div>
            </div>
        </div>
    </section>
    <footer>
        <p>Made with <svg viewBox="0 0 1792 1792" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg" style="height: 0.8rem;"><path d="M896 1664q-26 0-44-18l-624-602q-10-8-27.5-26T145 952.5 77 855 23.5 734 0 596q0-220 127-344t351-124q62 0 126.5 21.5t120 58T820 276t76 68q36-36 76-68t95.5-68.5 120-58T1314 128q224 0 351 124t127 344q0 221-229 450l-623 600q-18 18-44 18z" fill="#e25555"></path></svg> in our Web-Dev Class @ Esade</p>
        <span class="footertext" style="text-align: center; margin: 0 auto; width: 100%; font-size: xx-small; display: block; padding-bottom: 10px; color: lightslategrey;">Version 1.3</span>
    </footer>

    <script>
    var labels = ['nature', 'beach', 'bowling', 'cars', 'city', 'landscape', 'architecture', 'abstract', 'minimalistic'];
var agents = [];
var hiredAgents = [];
 $('.agent-grid2').on('click', '.hire-agent, .unhire-agent', function(e) {
    e.preventDefault();
    var button = $(this);
    var agentId = button.data('agent-id');

    // Change button appearance
    button.html('<i class="fas fa-check"></i>'); // Replaces "Hire" text with checkmark
    button.css('background-color', 'green');
    button.css('color', 'white');

    // Send a request to the server
    $.ajax({
        url: 'new_hire.php',
        type: 'post',
        data: {
            agent_id: agentId
        },
        success: function(response) {
            if (response.message === 'Agent hired successfully.') {
                button.css('background-color', 'green');
                button.html('<i class="fas fa-check"></i>');
                button.prop('disabled', true);
                hiredAgents.push(agentId);
                setTimeout(function() {
                    //add .unhire-agent class
                    button.css('background-color', '');
                    button.css('color', '');
                    button.addClass('unhire-agent');
                    button.html('<i class="fas fa-times"></i> Unhire');
                    button.prop('disabled', false);
                }, 1500);
            } else if (response.message === 'Agent unhired successfully.') {
                button.removeClass('unhire-agent');
                button.css('background-color', '');
                button.html('Hire');
                hiredAgents = hiredAgents.filter(function(id) {
                    return id !== agentId;
                });
            } else {
                button.css('background-color', 'grey');
                button.html('<i class="fa fa-repeat"></i> Try again');
            }
        },
        error: function(jqXHR, textStatus, errorThrown) {
            console.log(textStatus, errorThrown);
        }
    });
});

$('.agent-grid-hired').on('click', '.hire-agent, .unhire-agent', function(e) {
    e.preventDefault();
    var button = $(this);
    var agentId = button.data('agent-id');

    

    // Send a request to the server
    $.ajax({
        url: 'new_hire.php',
        type: 'post',
        data: {
            agent_id: agentId
        },
        success: function(response) {
            if (response.message === 'Agent hired successfully.') {
                button.css('background-color', 'green');
                button.html('<i class="fas fa-check"></i>');
                button.prop('disabled', true);
                hiredAgents.push(agentId);
                setTimeout(function() {
                    //add .unhire-agent class
                    button.css('background-color', '');
                    button.css('color', '');
                    button.addClass('unhire-agent');
                    button.html('<i class="fas fa-times"></i> Unhire');
                    button.prop('disabled', false);
                }, 1500);
            } else if (response.message === 'Agent unhired successfully.') {
                button.removeClass('unhire-agent');
                button.css('background-color', '');
                button.html('<i class="fa fa-repeat"></i>Re-Hire?');
                hiredAgents = hiredAgents.filter(function(id) {
                    return id !== agentId;
                });
            } else {
                button.css('background-color', 'grey');
                button.html('<i class="fa fa-repeat"></i> Try again');
            }
            GlobalFunc.functionToRun();
        },
        error: function(jqXHR, textStatus, errorThrown) {
            console.log(textStatus, errorThrown);
        }
    });
});

function displayAgentsWithHire(agents) {
    $.ajax({
        url: 'fetch_hired_agents.php',
        type: 'get',
        dataType: 'json',
        success: function(response) {
            hiredAgents = response.map(function(agent) {
            return agent.agent_id;
            });
            displayAgents(agents);
            displayHiredAgents(response);
        },
        error: function(jqXHR, textStatus, errorThrown) {
            console.log(textStatus, errorThrown);
        }
    });
}

// Function to filter agents based on a search term
function filterAgents(term) {
    return agents.filter(function(agent) {
        return agent.agent_firstname && agent.agent_firstname.toLowerCase().includes(term.toLowerCase()) ||
            agent.agent_lastname && agent.agent_lastname.toLowerCase().includes(term.toLowerCase()) ||
            agent.agent_city && agent.agent_city.toLowerCase().includes(term.toLowerCase()) ||
            agent.agent_country && agent.agent_country.toLowerCase().includes(term.toLowerCase()) ||
            agent.agent_exp && agent.agent_exp.toLowerCase().includes(term.toLowerCase()) ||
            agent.agent_about && agent.agent_about.toLowerCase().includes(term.toLowerCase());
    });
}

// Function to display agents
function displayAgents(filteredAgents) {
    var html = '';

    $.each(filteredAgents, function(index, agent) {
        // Determine gender and create avatar URL
        var avatarUrl = 'https://i.pravatar.cc/150?u='+(agent.user_id);

        // Create background image URL
        var bgImageUrl = 'https://source.unsplash.com/featured/300x' + (201 + agent.index) + '?' + agent.label;
        var websiteUrl = agent.agent_website.includes('http') ? agent.agent_website : 'http://' + agent.agent_website;

        // Create agent card
        //var buttonClass = hiredAgents.includes(agent.agent_id) ? 'unhire-agent' : 'hire-agent';
        //var buttonLabel = hiredAgents.includes(agent.agent_id) ? 'Unhire' : 'Hire';

        // Create agent card
        html += '<div class="agent-card agent-card-subpage">';
        html += '<div style="background-image: url(\'' + bgImageUrl + '\');" class="agent-cover">';
        if (agent.pro) {
            html += '<span class="pro">PRO</span>';
        }
        html += '</div>';
        html += '<div class="agent-content">';
        html += '<img src="' + avatarUrl + '" alt="profile" class="agent-profile" />';
        html += '<h2>' + agent.agent_firstname + ' ' + agent.agent_lastname + '<span>' + agent.agent_exp + '</span></h2>';
        html += '<p>' + agent.agent_about + '</p>';
        // If the agent is hired, show the 'Unhire' state. Otherwise, show the 'Hire' state
        if (hiredAgents && hiredAgents.includes(agent.agent_id)) {
            html += '<a href="#" data-agent-id="' + agent.agent_id + '" class="agent-action hire-agent unhire-agent"><i class="fas fa-times"></i> Unhire</a>';
        } else {
            html += '<a href="#" data-agent-id="' + agent.agent_id + '" class="agent-action hire-agent">Hire</a>';
        }
        html += '<a target="_blank" href="' + websiteUrl + '" class="agent-action more-info" style="padding: 7px;color: #ffffff;font-size: 0.7em;text-transform: uppercase;margin: 10px 0;display: inline-block;opacity: 1;width: 47%;text-align: center;text-decoration: none;font-weight: bold;">Website</a>';
        html += '</div></div>';
    });

    // Update the agent grid
    $('.agent-grid2').html(html);
}

function displayHiredAgents(hiredAgents) {
    var html = '';

    console.log(hiredAgents);
    if (hiredAgents.length < 1) {
        $('.my-hired').hide();
    } else {
        $('.my-hired').show();
    }

    $.each(hiredAgents, function(index, agent) {
        var avatarUrl = 'https://i.pravatar.cc/150?u='+(agent.user_id);
        var bgImageUrl = 'https://source.unsplash.com/featured/300x' + (201 + agent.user_id);
        var websiteUrl = agent.agent_website.includes('http') ? agent.agent_website : 'http://' + agent.agent_website;

        html += '<div class="agent-card agent-card-subpage">';
        html += '<div style="background-image: url(\'' + bgImageUrl + '\');" class="agent-cover">';
        if (agent.pro) {
            html += '<span class="pro">PRO</span>';
        }
        html += '</div>';
        html += '<div class="agent-content">';
        html += '<img src="' + avatarUrl + '" alt="profile" class="agent-profile" />';
        html += '<h2>' + agent.agent_firstname + ' ' + agent.agent_lastname + '<span>' + agent.agent_exp + '</span></h2>';
        html += '<span>' + agent.agent_city + ','+agent.agent_country+'</p>';
        html += '<p>' + agent.agent_about + '</p>';
        html += '<a href="#" data-agent-id="' + agent.agent_id + '" class="agent-action hire-agent unhire-agent"><i class="fas fa-times"></i> Unhire</a>';
        html += '<a target="_blank" href="' +  websiteUrl + '" class="agent-action more-info" style="padding: 7px;color: #ffffff;font-size: 0.7em;text-transform: uppercase;margin: 10px 0;display: inline-block;opacity: 1;width: 47%;text-align: center;text-decoration: none;font-weight: bold;">Website</a>';
        html += '</div></div>';
    });

    $('.agent-grid-hired').html(html);
}

//global function to run the agentfetch
var GlobalFunc = function(){}

$(document).ready(function() {
    $.get('getUserId.php', function(data) {
        var userIdElement = '<span class="user-id" style="text-align: center; margin: 0 auto; width: 100%; font-size: xx-small; display: block; padding-bottom: 10px; color: lightslategrey;">User ID: ' + data + '</span>';
        $(userIdElement).insertAfter('.footertext');
    });

    // Load all agents
    GlobalFunc = function () { 
        var functionToRun = function() { 
    $.getJSON('all_agents.php', function(data) {
        console.log("Received data from server:", data);

        agents = data;

        $.each(agents, function(index, agent) {
            // Determine gender and store on agent object
            agent.gender = (index % 2 == 0) ? 'male' : 'female';

            // Select a label for the background image URL and store on agent object
            agent.label = labels[index % labels.length];
            //assign pro status on random basis
            agent.pro = (Math.random() > 0.5) ? true : false;

            // Store index on agent object
            agent.index = index;
        });
        // Display all agents initially
        displayAgentsWithHire(agents);
        });
        }
    }
    GlobalFunc.functionToRun();

    // Handle search input keyup event
    $('.search-input').on('keyup', function() {
        var searchTerm = $(this).val();

        // Filter and display agents
        var filteredAgents = filterAgents(searchTerm);
        displayAgentsWithHire(filteredAgents);
    });
});
    </script>
    <script src="js/main.js"></script>
</body>
</html>
